# 系统设计说明

## 1. 项目定位
`YD-ShotMind-Engine` 是一个基于 Next.js 的短剧生产引擎，围绕“项目 -> 剧集 -> 分镜 -> 媒体资产”进行管理，并提供 AI 生成能力（文本、分镜、TTS 等）。

## 2. 技术架构
- 前端与服务端：Next.js App Router（同仓全栈）
- 数据层：Prisma + MySQL
- AI 能力编排：`src/lib/ai/orchestrator.ts`
- 运行时：Node.js

整体采用单体应用架构：
1. 页面层（`src/app/**`）负责交互与展示
2. API 路由层（`src/app/api/**`）负责业务接口
3. 领域与基础设施层（`src/lib/**`）负责数据库与外部能力封装
4. 持久化层（`prisma/schema.prisma`）负责数据模型定义

## 3. 核心数据模型
数据模型定义见 `prisma/schema.prisma`，关键实体：
- `Project`：项目主表（名称、描述、集数、状态）
- `Character` / `CharacterAngleImage`：角色与多角度形象
- `Scene`：场景信息（地点、时段、背景）
- `Episode`：剧集信息（标题、梗概、对白、状态）
- `Shot`：分镜信息（镜头类型、提示词、媒体路径、状态）
- `Asset`：素材表（图/音/视频来源与元数据）
- `Task`：异步任务状态（进度、输入输出、错误）

关系上以 `Project` 为根，向下级联到角色、场景、剧集、分镜与任务。

## 4. API 与页面组织
- 页面路由：`src/app/projects/**`（项目管理、角色、场景、剧集、生成页等）
- API 路由：`src/app/api/**`
  - 项目：`/api/projects`
  - 角色：`/api/projects/[projectId]/characters`、`/api/characters/[id]`
  - 场景：`/api/projects/[projectId]/scenes`、`/api/scenes/[id]`
  - 剧集/分镜：`/api/projects/[projectId]/episodes`、`/api/episodes/[id]/shots`
  - 生成能力：`/api/generation/tts`

## 5. AI 编排设计
`src/lib/ai/orchestrator.ts` 统一封装 AI 调用入口：
- 支持 OpenAI 与 Anthropic 双模型
- 根据配置选择可用 provider
- 提供领域级生成方法：
  - `generateOutline`
  - `generateCharacters`
  - `generateScenes`
  - `generateDialogue`
  - `generateShots`

## 6. 状态流转（概念）
- 项目：`DRAFT -> GENERATING -> COMPLETED`
- 剧集：`PENDING -> GENERATING -> COMPLETED/FAILED`
- 分镜：`PENDING -> GENERATING -> COMPLETED/FAILED`
- 任务：`PENDING -> PROCESSING -> COMPLETED/FAILED`

## 7. 文件与资源
- 上传资源目录：`public/uploads/`（已忽略版本管理）
- Prisma 迁移目录：`prisma/migrations/`

## 8. 后续可扩展方向
- 引入消息队列与 worker 解耦长任务
- 对任务表增加重试策略与幂等键
- 增加统一鉴权与多租户隔离策略
- 增加可观测性（日志、追踪、告警）
